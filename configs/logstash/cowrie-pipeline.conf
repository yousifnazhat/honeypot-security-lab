# =============================================================================
# Logstash Pipeline Configuration - Cowrie Honeypot Logs
# Virtual Honeypot Security Monitoring Lab
# =============================================================================
# This pipeline ingests Cowrie JSON logs, enriches them with GeoIP data,
# and outputs to Elasticsearch for Kibana visualization.
# Place at: /etc/logstash/conf.d/cowrie-pipeline.conf
# =============================================================================

input {
  # Read Cowrie JSON log files
  file {
    path => "/var/log/cowrie/cowrie.json"
    codec => json
    type => "cowrie"
    start_position => "beginning"
    sincedb_path => "/var/lib/logstash/sincedb_cowrie"
    tags => ["honeypot", "ssh"]
  }
}

filter {
  if [type] == "cowrie" {

    # --- Parse Timestamp ---
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }

    # --- Add Metadata ---
    mutate {
      add_field => {
        "honeypot_type" => "ssh"
        "lab_environment" => "virtual"
        "honeypot_software" => "cowrie"
      }
      # Rename fields for consistency
      rename => {
        "src_ip" => "attacker_ip"
        "dst_ip" => "honeypot_ip"
        "username" => "attempted_username"
        "password" => "attempted_password"
      }
    }

    # --- Categorize Event Type ---
    if [eventid] == "cowrie.login.success" {
      mutate { add_tag => ["login_success"] }
    } else if [eventid] == "cowrie.login.failed" {
      mutate { add_tag => ["login_failed"] }
    } else if [eventid] == "cowrie.command.input" {
      mutate { add_tag => ["command_executed"] }
    } else if [eventid] == "cowrie.session.connect" {
      mutate { add_tag => ["new_connection"] }
    } else if [eventid] == "cowrie.direct-tcpip.request" {
      mutate { add_tag => ["tunnel_attempt"] }
    }

    # --- GeoIP Enrichment ---
    if [attacker_ip] {
      geoip {
        source => "attacker_ip"
        target => "geoip"
        database => "/usr/share/GeoIP/GeoLite2-City.mmdb"
        add_field => ["[geoip][coordinates]", "%{[geoip][longitude]}"]
        add_field => ["[geoip][coordinates]", "%{[geoip][latitude]}"]
      }
      mutate {
        convert => ["[geoip][coordinates]", "float"]
      }
    }

    # --- Password Analysis ---
    if [attempted_password] {
      ruby {
        code => '
          password = event.get("attempted_password").to_s
          event.set("password_length", password.length)
          event.set("password_has_numbers", password.match?(/\d/))
          event.set("password_has_special", password.match?(/[^a-zA-Z0-9]/))
          event.set("password_is_common", ["123456","password","admin","root","qwerty"].include?(password))
        '
      }
    }
  }
}

output {
  if [type] == "cowrie" {
    # --- Elasticsearch ---
    elasticsearch {
      hosts => ["http://localhost:9200"]
      index => "cowrie-logs-%{+YYYY.MM.dd}"
      template_name => "cowrie-logs"
    }

    # --- Console (debug) ---
    stdout {
      codec => rubydebug {
        metadata => false
      }
    }
  }
}
